name: Publish to Firefox Addon Gallery

on:
  push:
    tags:
      - v*

  workflow_dispatch:
jobs:
  pack-addon:
    uses: ./.github/workflows/pack_addon.yml
    with:
      addonType: 'firefox'
  publish:
    runs-on: ubuntu-latest
    needs: pack-addon
    steps:
      - name: Download packed addon artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ needs.pack-addon.outputs.artifactName }}
          path: packed-addon-artifact
    
      - name: Generate JWT token
        id: jwt-token-generate
        uses: morzzz007/github-actions-jwt-generator@1.0.1
        with:
          secret: ${{ secrets.FIREFOX_GALLERY_API_SECRET }}
          payload: > 
            {
              "iss": "${{ secrets.FIREFOX_GALLERY_API_SECRET }}"
            }

      - name: Upload firefox addon
        id: firefox-upload-request
        uses: fjogeleit/http-request-action@v1
        with:
          url: "https://addons.mozilla.org/api/v5/api/v5/addons/upload/"
          method: 'POST'
          bearerToken: ${{ steps.jwt-token-generate.outputs.jwt }}
          contentType: multipart/form-data
